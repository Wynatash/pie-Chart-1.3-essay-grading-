<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IELTS Writing Task 1 - AI Examiner</title>
<meta name="description" content="Luyện viết IELTS Writing Task 1 với trợ lý AI chị Uyên. Phân tích biểu đồ, chấm điểm chi tiết, gợi ý cải thiện.">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
<style>
/* --- GIỮ NGUYÊN CSS GỐC CỦA BẠN --- */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:#fff;color:#222}
h1,h2,h3,h4{font-family:'Outfit',sans-serif}
.green{color:#13a62e}
.bg-green{background:#13a62e}
.bg-green-light{background:#e5f6e9}
.border-green{border-color:rgba(19,166,46,0.3)}
button{cursor:pointer;font-family:'DM Sans',sans-serif}
input,textarea{font-family:'DM Sans',sans-serif}

.api-key-bar{position:fixed;top:0;right:0;z-index:999;display:flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(255,255,255,0.95);border-bottom-left-radius:8px;border:1px solid #ddd;font-size:12px;box-shadow:0 1px 4px rgba(0,0,0,0.08)}
.api-key-bar label{color:#666;white-space:nowrap}
.api-key-bar input{border:1px solid #ccc;border-radius:4px;padding:3px 8px;font-size:12px;width:260px}
.api-key-bar .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.dot-green{background:#13a62e}
.dot-red{background:#e53e3e}

.layout{display:flex;height:100vh;width:100%}
.panel{width:50%;height:100vh;overflow-y:auto}
.panel-left{border-right:1px solid #e5e7eb;background:#f9fafb;display:flex;flex-direction:column}
.panel-right{padding:24px}

.chart-container{border:2px solid rgba(19,166,46,0.3);border-radius:8px;overflow:hidden;background:#fff;max-width:500px;width:100%}
.chart-container img{width:100%;display:block}

.form-label{font-size:14px;font-weight:700;color:#13a62e;margin-bottom:4px;display:block}
.form-input{width:100%;border:1px solid rgba(19,166,46,0.3);border-radius:6px;padding:10px 12px;font-size:14px;background:#e5f6e9;outline:none;transition:border-color .2s}
.form-input:focus{border-color:#13a62e}
textarea.form-input{resize:vertical;min-height:280px;line-height:1.7;font-size:16px}

.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 20px;border-radius:6px;font-weight:700;font-size:14px;border:none;transition:opacity .2s}
.btn:hover{opacity:0.9}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.btn-primary{background:#13a62e;color:#fff}
.btn-outline{background:transparent;border:2px solid #13a62e;color:#13a62e}
.btn-ghost{background:transparent;color:#666;border:1px solid #ddd}
.btn-sm{padding:6px 14px;font-size:12px}

.score-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.score-card{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;animation:fadeUp .4s ease both}
.score-card .score{font-size:28px;font-weight:700}
.score-card .label{font-size:10px;text-align:center;color:#888;font-weight:500;margin-top:4px;text-transform:uppercase;letter-spacing:.5px}
.score-overall{grid-column:1/-1;border:2px solid rgba(19,166,46,0.3);background:#e5f6e9}
.score-overall .score{font-size:36px;color:#13a62e}
.score-emerald{color:#047857}
.score-amber{color:#d97706}
.score-red{color:#dc2626}

.question-card{background:#fff;border-radius:8px;border:1px solid #e5e7eb;box-shadow:0 1px 3px rgba(0,0,0,0.06);padding:16px;margin-bottom:12px}
.q-number{width:28px;height:28px;background:#13a62e;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0}
.q-row{display:flex;align-items:flex-start;gap:12px}
.q-text{color:#333;line-height:1.6;font-size:14px;flex:1}

.hint-box{margin-top:12px;margin-left:40px}
.hint-label{font-size:12px;font-weight:700;color:#d97706;margin-bottom:4px;display:flex;align-items:center;gap:4px}
.hint-text{font-size:14px;color:#92400e;background:#fffbeb;padding:8px 12px;border-radius:6px;border:1px solid #fde68a}

.btn-help{border:1px solid #fcd34d;background:#fffbeb;color:#b45309;font-size:12px;padding:6px 14px;border-radius:6px;font-weight:500;margin-top:12px;margin-left:40px}
.btn-help.active{background:#fef3c7;border-color:#f59e0b;font-weight:700}

.data-check{padding:16px;border-radius:8px;display:flex;align-items:flex-start;gap:12px}
.data-check.correct{background:#f0fdf4;border:1px solid #bbf7d0}
.data-check.incorrect{background:#fef2f2;border:1px solid #fecaca}

.feedback-box{background:#eff6ff;border:1px solid #dbeafe;border-radius:8px;padding:16px}
.feedback-box h4{font-size:14px;font-weight:700;color:#1e3a5f;margin-bottom:12px}
.feedback-section{color:#1e40af;font-size:14px;line-height:1.7;margin-bottom:16px}
.feedback-section:last-child{margin-bottom:0}

.essay-display{font-size:16px;line-height:1.9;white-space:pre-wrap;color:#333;background:#fff;padding:16px;border-radius:8px;border:1px solid #e5e7eb}
.hl-grammar{background:#e5f6e9;border-bottom:2px solid #13a62e;padding:0 2px;border-radius:2px;cursor:pointer;transition:all .15s}
.hl-grammar:hover{background:#d1ebd6}
.hl-grammar.active{box-shadow:0 0 0 2px #13a62e,0 0 0 4px rgba(19,166,46,0.2)}
.hl-vocab{background:#FFFAF6;border-bottom:2px solid #e88a2d;padding:0 2px;border-radius:2px;cursor:pointer;transition:all .15s}
.hl-vocab:hover{background:#fff0e0}
.hl-vocab.active{box-shadow:0 0 0 2px #e88a2d,0 0 0 4px rgba(232,138,45,0.2)}

.error-explain{padding:16px;border-radius:8px;animation:fadeUp .3s ease}
.error-explain.grammar-type{background:#e5f6e9;border:1px solid rgba(19,166,46,0.3)}
.error-explain.vocab-type{background:#FFFAF6;border:1px solid rgba(232,138,45,0.3)}
.error-explain .error-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:14px;font-weight:700}
.error-explain .original{padding:8px;border-radius:6px;margin-bottom:8px;font-size:14px}
.grammar-type .original{background:#fef2f2;color:#b91c1c;text-decoration:line-through}
.vocab-type .original{background:#fff7ed;color:#9a3412}
.error-explain .suggestion{padding:8px;border-radius:6px;font-size:14px}

.chat-closed{background:#e5f6e9;border:1px solid rgba(19,166,46,0.2);border-radius:8px;padding:16px;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
.chat-header{background:#13a62e;color:#fff;padding:12px 16px;border-radius:8px 8px 0 0;display:flex;align-items:center;justify-content:space-between;gap:8px}
.chat-body{max-height:300px;overflow-y:auto;padding:16px}
.chat-footer{display:flex;align-items:center;gap:8px;padding:12px;border-top:1px solid #e5e7eb}
.chat-footer input{flex:1;border:1px solid #e5e7eb;border-radius:6px;padding:8px 12px;font-size:14px;outline:none}
.chat-footer input:focus{border-color:#13a62e}
.chat-footer button{width:36px;height:36px;border-radius:6px;background:#13a62e;color:#fff;border:none;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.msg-user{display:flex;justify-content:flex-end;margin-bottom:12px}
.msg-user .bubble{background:#13a62e;color:#fff;padding:8px 12px;border-radius:8px;max-width:85%;font-size:14px;line-height:1.6}
.msg-assistant{display:flex;justify-content:flex-start;margin-bottom:12px}
.msg-assistant .bubble{background:#f3f4f6;color:#333;padding:8px 12px;border-radius:8px;max-width:85%;font-size:14px;line-height:1.6}
.suggestion-btn{display:block;width:100%;text-align:left;font-size:12px;color:#13a62e;background:#e5f6e9;padding:8px 12px;border-radius:6px;border:none;margin-bottom:8px;cursor:pointer;transition:background .15s}
.suggestion-btn:hover{background:#d0efd6}

.share-box{background:#e5f6e9;border:1px solid rgba(19,166,46,0.2);border-radius:8px;padding:16px}

.legend{display:flex;gap:12px;font-size:12px;margin-bottom:4px;flex-wrap:wrap;align-items:center}
.legend-dot{width:12px;height:12px;border-radius:2px;display:inline-block;vertical-align:middle}

.loading-center{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;min-height:400px;gap:16px}

@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:48px;height:48px;border:4px solid #e5f6e9;border-top-color:#13a62e;border-radius:50%;animation:spin .8s linear infinite}
.spinner-sm{width:14px;height:14px;border-width:2px}

@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

@media(max-width:768px){
  .layout{flex-direction:column}
  .panel{width:100%;height:auto;min-height:50vh}
  .score-grid{grid-template-columns:repeat(2,1fr)}
  .api-key-bar input{width:160px}
}
</style>
</head>
<body>

<div id="app"></div>

<script>
const DATA_REFERENCE = `
- Japan: Housing (21%), Food (24%), Other goods & services (29%), Transport (20%), Health care (6%).
- Malaysia: Housing (34%), Food (27%), Other goods & services (26%), Transport (10%), Health care (3%).
`;
const CHART_IMG = "https://lh3.googleusercontent.com/d/1iDPrDFava4u1PektI8DtJW4wUuNoXUu3";

// URL App Script MỚI NHẤT
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbySZoNoC1880caP1tQUxt9BAHB2cYchDTyLl4Hmuhbie8caNuLt_dnxdrWhdGrFczw-UA/exec";

let state = {
  stage: 'idle',
  studentName: '',
  essay: '',
  editableEssay: '',
  feedback: null,
  selectedCorrection: null,
  selectedCorrectionIdx: null,
  helpSet: new Set(),
  chatOpen: false,
  chatMessages: [],
  chatInput: '',
  chatLoading: false,
};

function sanitizeAndParse(raw) {
  let text = raw.replace(/[\x00-\x1F\x7F]/g, ch => '\n\r\t'.includes(ch) ? ' ' : '');
  const m = text.match(/\{[\s\S]*\}/);
  if (m) text = m[0];
  return JSON.parse(text);
}

// Hàm gửi dữ liệu về Google Sheet (FIXED: Sử dụng text/plain + no-cors)
function sendToGoogleSheet(studentName, essayContent, totalScore, detailedResults) {
  const data = JSON.stringify({
    studentName: studentName,
    essayContent: essayContent,
    totalScore: totalScore,
    detailedResults: detailedResults
  });

  // Sử dụng fetch với mode no-cors và content-type text/plain để tránh lỗi CORS của Google Apps Script
  fetch(SCRIPT_URL, {
    method: "POST",
    mode: "no-cors", 
    headers: {
      "Content-Type": "text/plain"
    },
    body: data
  })
  .then(() => {
    // Vì mode no-cors trả về opaque response nên ta coi như thành công nếu không có lỗi mạng
    alert("✅ Đã lưu kết quả bài làm vào hệ thống thành công!");
    console.log("Data sent to sheet");
  })
  .catch((error) => {
    console.error("Lỗi gửi dữ liệu:", error);
    alert("⚠️ Có lỗi khi lưu dữ liệu. Vui lòng chụp màn hình kết quả lại.");
  });
}

// --- CÁC HÀM XỬ LÝ GEMINI (GIỮ NGUYÊN) ---
function sanitizeAndParse(text) {
  try {
    return JSON.parse(text);
  } catch {
    return {};
  }
}

async function callGemini(prompt, retries = 2) {
  let lastErr;

  for (let i = 0; i <= retries; i++) {
    try {

      const res = await fetch("https://fragrant-frog-098.uyen3202.workers.dev/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [
            {
              role: "user",
              parts: [{ text: prompt }]
            }
          ],
          generationConfig: {
            responseMimeType: "application/json"
          }
        })
      });

      if (!res.ok) {
        const errText = await res.text();
        throw new Error(errText);
      }

      const data = await res.json();
      const raw = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";

      return sanitizeAndParse(raw);

    } catch (e) {
      lastErr = e;
      if (i < retries)
        await new Promise(r => setTimeout(r, 1000));
    }
  }

  throw lastErr;
}

async function getSocraticFeedback(essay, helpQuestions) {
  const helpSection = helpQuestions && helpQuestions.length > 0
    ? `\n=== CÂU HỎI HỌC SINH CẦN GỢI Ý TRỰC TIẾP ===\nHọc sinh đã bấm nút xin gợi ý cho các câu hỏi sau. Trả mảng "socraticHints" với ĐÚNG THỨ TỰ, mỗi phần tử là object {"question": "<giữ nguyên câu hỏi gốc>", "hint": "<gợi ý ngắn gọn>"}.\nGỢI Ý PHẢI NGẮN GỌN (tối đa 1-2 câu), dễ hiểu, chỉ nói thẳng cần sửa gì.\n${helpQuestions.map((q,i) => `${i+1}. "${q}"`).join("\n")}\n`
    : '';

  const prompt = `Role: Chị Uyên - giáo viên luyện thi IELTS Writing Task 1 cho học sinh Việt Nam. Chị xưng "chị", gọi học sinh là "em".
Task: Đọc bài viết của học sinh, đối chiếu với biểu đồ gốc, rồi đặt câu hỏi Socratic bằng tiếng Việt để giúp em sửa các lỗi cơ bản trước khi chấm điểm.

Biểu đồ gốc: Chi tiêu hộ gia đình (Household Expenditures) tại Nhật Bản và Malaysia năm 2010.
Số liệu chính xác từ biểu đồ: ${DATA_REFERENCE}
${helpSection}
=== QUY TẮC ĐẶT CÂU HỎI (BẮT BUỘC) ===
LUÔN LUÔN trả về TẤT CẢ câu hỏi trong MỘT LẦN duy nhất. KHÔNG giới hạn số lượng.
- Nếu bài có nhiều lỗi → đặt nhiều câu hỏi (có thể 5-10 câu hoặc hơn)
- Nếu bài khá tốt → vẫn phải đặt TỐI THIỂU 3-5 câu hỏi gợi ý cải thiện cụ thể
- Nếu bài gần như hoàn hảo → vẫn đặt TỐI THIỂU 3 câu gợi ý nâng cao CỤ THỂ
QUAN TRỌNG: Mỗi câu hỏi chỉ hỏi MỘT vấn đề duy nhất. KHÔNG gộp nhiều vấn đề. Mỗi câu hỏi phải NGẮN GỌN (1-2 câu).

1. PHẢI đối chiếu trực tiếp bài viết với biểu đồ gốc.
   - KHÔNG được hỏi chung chung. PHẢI chỉ ra điểm mâu thuẫn cụ thể.
2. Các nhóm lỗi cần kiểm tra: Nội dung (Task Achievement), Tính mạch lạc (Coherence), Ngữ pháp (Grammar).
3. TUYỆT ĐỐI KHÔNG dùng từ ngữ trừu tượng.
5. KHÔNG bắt đầu câu hỏi bằng lời chào.
4. Nếu bài viết không có lỗi ở nhóm nào, vẫn đặt câu hỏi gợi ý cải thiện CỤ THỂ.

IMPORTANT: Return ONLY valid JSON.
Output: JSON { "socraticQuestions": ["câu hỏi mới 1", ...], "socraticHints": [{"question": "câu hỏi gốc", "hint": "gợi ý ngắn gọn"}], "corrections": [] }

Bài viết của học sinh:
"${essay}"`;

  return await callGemini(prompt);
}

async function getFullGrading(essay) {
  const prompt = `Role: Chị Uyên - giáo viên luyện thi IELTS Writing Task 1 cho học sinh Việt Nam. Chị xưng "chị", gọi học sinh là "em".
Task: Chấm bài viết. Giải thích bằng tiếng Việt, dùng giọng thân thiện, gọi học sinh là "em".
Chart: Household Expenditures in Japan and Malaysia 2010.
Data Reference: ${DATA_REFERENCE}

IMPORTANT: Return ONLY valid JSON.
You MUST return JSON in this EXACT structure:
{
  "socraticQuestions": [],
  "scores": {
    "taskAchievement": <number 0-9>,
    "coherenceCohesion": <number 0-9>,
    "lexicalResource": <number 0-9>,
    "grammaticalRangeAccuracy": <number 0-9>,
    "overall": <number 0-9>
  },
  "dataCheck": {
    "isCorrect": <boolean>,
    "errors": ["list of data inaccuracies if any"]
  },
  "corrections": [
    {
      "type": "grammar" or "vocabulary",
      "original": "<exact text from essay>",
      "correction": "<suggested fix>",
      "explanation": "<explanation in Vietnamese>",
      "hint": "<hint for grammar errors in Vietnamese>",
      "context": "<surrounding sentence>"
    }
  ],
  "generalFeedback": "<overall feedback in Vietnamese, structured as sections separated by '\\n\\n', each section has a bold heading starting with '**Heading:**' followed by concise content>"
}

Rules:
- "original" must be an EXACT substring from the essay
- For grammar errors: provide hint in "hint" field
- For vocabulary errors: "correction" = từ hay hơn, "explanation" = giải thích tại sao từ gợi ý hay hơn
- "overall" score = average of 4 criteria, rounded to nearest 0.5
- Check all data figures against the reference data
- generalFeedback: viết bằng tiếng Việt, KHÔNG dùng lời chào, chia thành 3-4 đoạn, mỗi đoạn bắt đầu bằng heading in đậm dạng "**Heading:**". Mỗi đoạn cách nhau bằng \\n\\n.

Essay: "${essay}"`;

  return await callGemini(prompt);
}

async function chatWithAssistant(essay, question, chatHistory) {
  const historyText = chatHistory.length > 0
    ? chatHistory.map(m => `${m.role === 'user' ? 'Học sinh' : 'Chị Uyên'}: ${m.content}`).join('\n')
    : '';

  const prompt = `Role: Chị Uyên - giáo viên luyện thi IELTS Writing Task 1 cho học sinh Việt Nam. Chị xưng "chị", gọi học sinh là "em".
Task: Trả lời câu hỏi của học sinh về bài viết, biểu đồ, từ vựng, ngữ pháp, hoặc cách viết IELTS Task 1.
Giọng điệu: thân thiện, dễ hiểu, ngắn gọn. Trả lời bằng tiếng Việt. KHÔNG bắt đầu bằng lời chào.

Biểu đồ: Chi tiêu hộ gia đình (Household Expenditures) tại Nhật Bản và Malaysia năm 2010.
Số liệu: ${DATA_REFERENCE}

Bài viết của học sinh:
"${essay}"

${historyText ? `Lịch sử trò chuyện:\n${historyText}\n` : ''}

Câu hỏi mới của học sinh: "${question}"

Quy tắc:
- Trả lời NGẮN GỌN, dễ hiểu (tối đa 3-4 câu trừ khi cần liệt kê)
- Nếu hỏi về từ vựng: đưa 2-3 từ thay thế kèm giải thích ngắn và ví dụ câu
- Nếu hỏi về ngữ pháp: giải thích quy tắc và đưa ví dụ sửa lại
- Nếu hỏi về biểu đồ: trả lời dựa trên số liệu chính xác
- Nếu hỏi về cách viết: đưa gợi ý cụ thể với ví dụ câu

IMPORTANT: Return ONLY valid JSON: { "answer": "câu trả lời" }`;

  const result = await callGemini(prompt);
  return result.answer || 'Xin lỗi, chị chưa trả lời được.';
}

function renderBold(text) {
  if (!text) return '';
  return text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function getScoreColor(s) {
  if (s >= 7) return 'score-emerald';
  if (s >= 5) return 'score-amber';
  return 'score-red';
}

function buildHighlightedEssay(text, corrections) {
  if (!corrections || corrections.length === 0) {
    return `<div class="essay-display">${escapeHtml(text)}</div>`;
  }
  let parts = [{type: 'text', content: text}];
  corrections.forEach((c, idx) => {
    const newParts = [];
    parts.forEach(part => {
      if (part.type === 'text') {
        const i = part.content.indexOf(c.original);
        if (i !== -1) {
          const before = part.content.slice(0, i);
          const after = part.content.slice(i + c.original.length);
          if (before) newParts.push({type: 'text', content: before});
          newParts.push({type: 'highlight', content: c.original, idx, hlType: c.type});
          if (after) newParts.push({type: 'text', content: after});
        } else {
          newParts.push(part);
        }
      } else {
        newParts.push(part);
      }
    });
    parts = newParts;
  });
  let html = '';
  parts.forEach(p => {
    if (p.type === 'text') {
      html += escapeHtml(p.content);
    } else {
      const cls = p.hlType === 'grammar' ? 'hl-grammar' : 'hl-vocab';
      const active = state.selectedCorrectionIdx === p.idx ? ' active' : '';
      html += `<span class="${cls}${active}" onclick="selectCorrection(${p.idx})">${escapeHtml(p.content)}</span>`;
    }
  });
  return `<div class="essay-display">${html}</div>`;
}

function buildErrorExplanation(c) {
  if (!c) return '';
  const isGrammar = c.type === 'grammar';
  const cls = isGrammar ? 'grammar-type' : 'vocab-type';
  const headerColor = isGrammar ? 'color:#13a62e' : 'color:#e88a2d';
  const headerIcon = isGrammar ? 'Lỗi Ngữ pháp' : 'Gợi ý Từ vựng';
  let body = '';
  if (isGrammar) {
    body = `<div class="original">${escapeHtml(c.original)}</div>
      <div class="suggestion" style="background:#fff;padding:8px;border-radius:6px;color:#555;display:flex;align-items:flex-start;gap:8px">
        <strong>Gợi ý:</strong> ${escapeHtml(c.hint || c.explanation)}
      </div>`;
  } else {
    body = `<div class="original">${escapeHtml(c.original)}</div>
      <div class="suggestion" style="background:#fff7ed;padding:8px;border-radius:6px;color:#9a3412;font-weight:500">Từ hay hơn: ${escapeHtml(c.correction)}</div>
      <p style="color:#666;font-style:italic;font-size:14px;margin-top:8px">${escapeHtml(c.explanation)}</p>`;
  }
  return `<div class="error-explain ${cls}">
    <div class="error-header" style="${headerColor}">${headerIcon}</div>
    ${body}
  </div>`;
}

function selectCorrection(idx) {
  if (state.selectedCorrectionIdx === idx) {
    state.selectedCorrection = null;
    state.selectedCorrectionIdx = null;
  } else {
    state.selectedCorrection = state.feedback.corrections[idx];
    state.selectedCorrectionIdx = idx;
  }
  render();
}

function toggleHelp(idx) {
  if (state.helpSet.has(idx)) state.helpSet.delete(idx);
  else state.helpSet.add(idx);
  render();
}

async function handleSubmit(e) {
  if (e) e.preventDefault();
  const name = document.getElementById('nameInput')?.value?.trim();
  const essay = document.getElementById('essayInput')?.value?.trim();
  if (!name || !essay) { alert('Vui lòng nhập tên và bài viết!'); return; }
  if (essay.split(/\s+/).length < 20) { alert('Bài viết quá ngắn (tối thiểu 20 từ)!'); return; }
  state.studentName = name;
  state.essay = essay;
  state.editableEssay = essay;
  state.feedback = null;
  state.selectedCorrection = null;
  state.selectedCorrectionIdx = null;
  state.helpSet = new Set();
  state.stage = 'submitting';
  render();
  try {
    const fb = await getSocraticFeedback(essay);
    state.feedback = fb;
    state.stage = 'socratic';
  } catch (err) {
    alert('Lỗi: ' + err.message);
    state.stage = 'idle';
  }
  render();
}

async function handleResubmit() {
  const essay = state.editableEssay;
  const questions = state.feedback?.socraticQuestions || [];
  const helpQs = Array.from(state.helpSet).map(i => questions[i]).filter(Boolean);
  state.stage = 'submitting';
  state.selectedCorrection = null;
  state.selectedCorrectionIdx = null;
  render();
  try {
    const fb = await getSocraticFeedback(essay, helpQs.length > 0 ? helpQs : undefined);
    state.feedback = fb;
    state.helpSet = new Set();
    state.stage = 'socratic';
  } catch (err) {
    alert('Lỗi: ' + err.message);
    state.stage = 'socratic';
  }
  render();
}

async function handleGrade() {
  state.stage = 'grading';
  render();
  try {
    const fb = await getFullGrading(state.editableEssay);
    state.feedback = fb;
    state.stage = 'graded';
    state.chatOpen = false;
    state.chatMessages = [];
    state.chatInput = '';
    
    // Gửi dữ liệu về Sheet
    setTimeout(() => {
        const scoreVal = fb.scores?.overall || 0;
        const detailHtml = document.querySelector('.panel-right')?.innerHTML || "";
        sendToGoogleSheet(state.studentName, state.editableEssay, scoreVal, detailHtml);
    }, 500);

  } catch (err) {
    alert('Lỗi: ' + err.message);
    state.stage = 'socratic';
  }
  render();
}

async function handleResubmitFromGraded() {
  const essay = state.editableEssay;
  state.stage = 'submitting';
  state.selectedCorrection = null;
  state.selectedCorrectionIdx = null;
  render();
  try {
    const fb = await getSocraticFeedback(essay);
    state.feedback = fb;
    state.helpSet = new Set();
    state.stage = 'socratic';
  } catch (err) {
    alert('Lỗi: ' + err.message);
    state.stage = 'graded';
  }
  render();
}

function handleReset() {
  state = {stage:'idle',studentName:'',essay:'',editableEssay:'',feedback:null,selectedCorrection:null,selectedCorrectionIdx:null,helpSet:new Set(),chatOpen:false,chatMessages:[],chatInput:'',chatLoading:false};
  render();
}

function openChat() { state.chatOpen = true; render(); }
function closeChat() { state.chatOpen = false; render(); }

function setChatInput(val) { state.chatInput = val; render(); }

async function sendChat() {
  const q = state.chatInput.trim();
  if (!q || state.chatLoading) return;
  state.chatMessages.push({role:'user', content: q});
  state.chatInput = '';
  state.chatLoading = true;
  render();
  try {
    const answer = await chatWithAssistant(state.editableEssay, q, state.chatMessages.slice(0, -1));
    state.chatMessages.push({role:'assistant', content: answer});
  } catch {
    state.chatMessages.push({role:'assistant', content:'Xin lỗi, chị chưa trả lời được. Em thử hỏi lại nha.'});
  }
  state.chatLoading = false;
  render();
  setTimeout(() => {
    const chatBody = document.getElementById('chatBody');
    if (chatBody) chatBody.scrollTop = chatBody.scrollHeight;
  }, 50);
}

function renderIdleHome() {
  return `
  <div class="layout">
    <div class="panel panel-left" style="display:flex;align-items:center;justify-content:center;padding:24px">
      <div style="text-align:center">
        <h1 class="green" style="font-size:24px;margin-bottom:16px">Cùng viết bài PIE CHART nào</h1>
        <div class="chart-container" style="margin:0 auto">
          <img src="${CHART_IMG}" alt="Pie Chart - Household Expenditures">
        </div>
        <p style="font-size:12px;color:#888;margin-top:8px;font-style:italic">Household Expenditures in Japan and Malaysia (2010)</p>
        <div style="margin-top:20px;background:#fffbeb;border:1px solid #fde68a;border-radius:8px;padding:12px 16px;text-align:left;max-width:500px;width:100%">
          </p>
        </div>
      </div>
    </div>
    <div class="panel" style="padding:24px;display:flex;flex-direction:column">
      <form onsubmit="handleSubmit(event)" style="display:flex;flex-direction:column;flex:1;gap:12px">
        <div>
          <label class="form-label">Họ và Tên</label>
          <input type="text" id="nameInput" class="form-input" placeholder="Trịnh Trần Phương Tuấn" required>
        </div>
        <div style="flex:1;display:flex;flex-direction:column">
          <label class="form-label">Bài viết của em</label>
          <textarea id="essayInput" class="form-input" style="flex:1" placeholder="Viết bài phân tích biểu đồ vào đây (tối thiểu 50 từ)..." required></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m22 2-7 20-4-9-9-4z"/><path d="M22 2 11 13"/></svg>
          GỬI BÀI
        </button>
      </form>
    </div>
  </div>`;
}

function renderSocraticQuestions() {
  const fb = state.feedback;
  if (!fb) return '';
  const allItems = [];
  if (fb.socraticHints && fb.socraticHints.length > 0) {
    fb.socraticHints.forEach(h => {
      allItems.push({question: h.question, hint: h.hint, isHinted: true, questionIdx: -1});
    });
  }
  (fb.socraticQuestions || []).forEach((q, i) => {
    allItems.push({question: q, isHinted: false, questionIdx: i});
  });
  if (allItems.length === 0) return '<p style="color:#888">Không có câu hỏi nào.</p>';

  let html = `
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#13a62e" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
      <h3 class="green" style="font-size:18px">Chị có vài câu hỏi cho em nè</h3>
    </div>
    <p style="font-size:14px;color:#888;margin-bottom:16px">Em đọc kỹ rồi tự sửa bài bên trái nha. Câu nào không biết thì bấm xin gợi ý:</p>`;

  allItems.forEach((item, idx) => {
    html += `<div class="question-card">
      <div class="q-row">
        <span class="q-number">${idx + 1}</span>
        <p class="q-text">${escapeHtml(item.question)}</p>
      </div>`;
    if (item.isHinted && item.hint) {
      html += `<div class="hint-box">
        <div class="hint-label"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg> Đưa gợi ý rùi nhá!</div>
        <p class="hint-text">${escapeHtml(item.hint)}</p>
      </div>`;
    } else {
      const active = state.helpSet.has(item.questionIdx) ? ' active' : '';
      html += `<button class="btn-help${active}" onclick="toggleHelp(${item.questionIdx})">Em không biết hãy cíuu em T_T</button>`;
    }
    html += '</div>';
  });
  return html;
}

function renderGradedFeedback() {
  const fb = state.feedback;
  if (!fb) return '';
  let html = `<div class="panel-right"><h2 class="green" style="font-size:20px;border-bottom:2px solid #13a62e;padding-bottom:8px;margin-bottom:20px">KẾT QUẢ CHẤM ĐIỂM</h2>`;

  if (fb.scores) {
    const s = fb.scores;
    html += `<div class="score-grid">
      <div class="score-card" style="animation-delay:0.05s"><span class="score ${getScoreColor(s.taskAchievement)}">${s.taskAchievement.toFixed(1)}</span><span class="label">Task Achievement</span></div>
      <div class="score-card" style="animation-delay:0.1s"><span class="score ${getScoreColor(s.coherenceCohesion)}">${s.coherenceCohesion.toFixed(1)}</span><span class="label">Coherence & Cohesion</span></div>
      <div class="score-card" style="animation-delay:0.15s"><span class="score ${getScoreColor(s.lexicalResource)}">${s.lexicalResource.toFixed(1)}</span><span class="label">Lexical Resource</span></div>
      <div class="score-card" style="animation-delay:0.2s"><span class="score ${getScoreColor(s.grammaticalRangeAccuracy)}">${s.grammaticalRangeAccuracy.toFixed(1)}</span><span class="label">Grammar Range</span></div>
      <div class="score-card score-overall" style="animation-delay:0.25s"><span class="score">${s.overall.toFixed(1)}</span><span class="label">Overall Band Score</span></div>
    </div>`;
  }

  if (fb.dataCheck) {
    const dc = fb.dataCheck;
    const cls = dc.isCorrect ? 'correct' : 'incorrect';
    const icon = dc.isCorrect
      ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>'
      : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>';
    html += `<div class="data-check ${cls}" style="margin-top:20px">
      ${icon}
      <div>
        <h4 style="font-weight:700;font-size:14px;color:${dc.isCorrect ? '#166534' : '#991b1b'}">Kiểm tra số liệu</h4>`;
    if (dc.isCorrect) {
      html += '<p style="font-size:14px;color:#15803d;margin-top:4px">Tất cả số liệu chính xác.</p>';
    } else {
      html += '<ul style="list-style:disc;padding-left:20px;margin-top:4px;font-size:14px;color:#b91c1c">';
      (dc.errors || []).forEach(e => { html += `<li style="margin-bottom:4px">${escapeHtml(e)}</li>`; });
      html += '</ul>';
    }
    html += '</div></div>';
  }

  if (fb.generalFeedback) {
    html += `<div class="feedback-box" style="margin-top:20px">
      <h4>Nhận xét chung</h4>
      <div>`;
    fb.generalFeedback.split('\n\n').forEach(section => {
      html += `<div class="feedback-section">${renderBold(escapeHtml(section))}</div>`;
    });
    html += '</div></div>';
  }

  if (fb.corrections && fb.corrections.length > 0) {
    html += `<div style="margin-top:20px;padding:16px;background:#f9fafb;border-radius:8px;border:1px solid #e5e7eb;font-size:14px;color:#666">
      Chị phát hiện <strong>${fb.corrections.length}</strong> lỗi trong bài viết của em. Nhấn vào các từ được đánh dấu màu ở bài viết bên trái để xem chi tiết nha.
    </div>`;
  }
  html += '</div>'; // close panel-right

  html += renderChatAssistant();
  return html;
}

function renderChatAssistant() {
  if (!state.chatOpen) {
    return `<div class="chat-closed" style="margin-top:20px">
      <div style="display:flex;align-items:center;gap:8px">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#13a62e" stroke-width="2"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22z"/></svg>
        <div>
          <h4 style="font-weight:700;font-size:14px;color:#13a62e">Hỏi chị Uyên</h4>
          <p style="font-size:12px;color:#888">Hỏi về từ vựng, ngữ pháp, cách viết, hoặc biểu đồ</p>
        </div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="openChat()">Mở trợ lý</button>
    </div>`;
  }

  let messagesHtml = '';
  if (state.chatMessages.length === 0) {
    const suggestions = [
      'Có từ nào paraphrase cho "expenditures" không?',
      'Cách dùng "while" và "whereas" khác nhau thế nào?',
      'Làm sao viết overview hay hơn?'
    ];
    messagesHtml = '<div style="text-align:center;padding:16px"><p style="font-size:14px;color:#888;margin-bottom:12px">Em có thể hỏi chị bất kỳ điều gì, ví dụ:</p>';
    suggestions.forEach(s => {
      messagesHtml += `<button class="suggestion-btn" onclick="setChatInput('${s.replace(/'/g, "\\'")}')">${escapeHtml(s)}</button>`;
    });
    messagesHtml += '</div>';
  } else {
    state.chatMessages.forEach(m => {
      if (m.role === 'user') {
        messagesHtml += `<div class="msg-user"><div class="bubble">${escapeHtml(m.content)}</div></div>`;
      } else {
        messagesHtml += `<div class="msg-assistant"><div class="bubble">${renderBold(escapeHtml(m.content))}</div></div>`;
      }
    });
  }
  if (state.chatLoading) {
    messagesHtml += `<div class="msg-assistant"><div class="bubble" style="display:flex;align-items:center;gap:8px">
      <div class="spinner spinner-sm"></div><span style="font-size:12px;color:#888">Ối dồi hỏi hay quá, để chị nghĩ phát...</span>
    </div></div>`;
  }

  return `<div style="margin-top:20px;border:1px solid rgba(19,166,46,0.2);border-radius:8px;overflow:hidden">
    <div class="chat-header">
      <div style="display:flex;align-items:center;gap:8px">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22z"/></svg>
        <span style="font-weight:700;font-size:14px">Hỏi chị Uyên</span>
      </div>
      <button onclick="closeChat()" style="background:none;border:none;color:white;cursor:pointer;padding:4px">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>
    </div>
    <div class="chat-body" id="chatBody">${messagesHtml}</div>
    <div class="chat-footer">
      <input type="text" id="chatInputField" value="${escapeHtml(state.chatInput)}" placeholder="Hỏi về từ vựng, ngữ pháp, cách viết..." oninput="state.chatInput=this.value" onkeydown="if(event.key==='Enter'){event.preventDefault();sendChat()}" ${state.chatLoading ? 'disabled' : ''}>
      <button onclick="sendChat()" ${state.chatLoading || !state.chatInput.trim() ? 'disabled' : ''}>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m22 2-7 20-4-9-9-4z"/><path d="M22 2 11 13"/></svg>
      </button>
    </div>
  </div>`;
}

function renderTwoStageLayout() {
  const fb = state.feedback;
  let rightContent = '';

  if (state.stage === 'submitting') {
    rightContent = `<div class="loading-center">
      <div class="spinner"></div>
      <p class="green" style="font-size:18px;font-weight:700">Đợi xí để phân tích bài viết coi coi...</p>
      <p style="font-size:14px;color:#888">Khoảng 15-20 giây thôi nha hoặc lâu hơn tuỳ nhân phẩm</p>
    </div>`;
  } else if (state.stage === 'socratic') {
    rightContent = renderSocraticQuestions();
    rightContent += `<p style="font-size:14px;color:#666;text-align:center;margin:20px 0">Em đọc câu hỏi rồi sửa bài viết bên trái nha. Sửa xong thì gửi lại để kiểm tra tiếp, hoặc nộp luôn để xem điểm.</p>
    <div style="display:flex;flex-direction:column;gap:8px">
      <button class="btn btn-outline" style="width:100%" onclick="handleResubmit()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
        Gửi lại để kiểm tra tiếp
      </button>
      <button class="btn btn-primary" style="width:100%" onclick="handleGrade()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
        Em đã sửa xong - Nộp bài lấy điểm
      </button>
    </div>`;
  } else if (state.stage === 'grading') {
    rightContent = `<div class="loading-center">
      <div class="spinner"></div>
      <p class="green" style="font-size:18px;font-weight:700">VUÝP! Viết bài giỏi ghê, đợi chị chấm điểm chi tiết phát</p>
      <p style="font-size:14px;color:#888">Khoảng 20-30 giây thôi nha hoặc lâu hơn tuỳ nhân phẩm ấy</p>
    </div>`;
  } else if (state.stage === 'graded') {
    rightContent = renderGradedFeedback();
  }

  let essaySection = '';
  if (state.stage === 'graded' && fb?.corrections?.length > 0) {
    essaySection = `
      <div class="legend">
        <span style="display:flex;align-items:center;gap:4px"><span class="legend-dot" style="background:#e5f6e9;border:1px solid rgba(19,166,46,0.4)"></span> Ngữ pháp</span>
        <span style="display:flex;align-items:center;gap:4px"><span class="legend-dot" style="background:#FFFAF6;border:1px solid rgba(232,138,45,0.4)"></span> Từ vựng</span>
        <span style="color:#aaa">Nhấn vào lỗi để xem chi tiết</span>
      </div>
      <div style="flex:1;overflow-y:auto">${buildHighlightedEssay(state.editableEssay, fb.corrections)}</div>
      ${state.selectedCorrection ? buildErrorExplanation(state.selectedCorrection) : ''}`;
  } else {
    essaySection = `<textarea id="editableEssay" class="form-input" style="flex:1;min-height:200px;background:#fff;border-color:#e5e7eb;font-size:16px;line-height:1.7" oninput="state.editableEssay=this.value">${escapeHtml(state.editableEssay)}</textarea>`;
  }

  let resubmitBtn = '';
  if (state.stage === 'graded') {
    resubmitBtn = `<button class="btn btn-primary" style="width:100%" onclick="handleResubmitFromGraded()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
      Nộp lại & Chấm điểm mới
    </button>`;
  }

  return `
  <div class="layout">
    <div class="panel panel-left">
      <div style="padding:16px 16px 8px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:12px">
          <h1 class="green" style="font-size:18px">Cùng viết bài PIE CHART nào</h1>
          <button class="btn btn-ghost btn-sm" onclick="handleReset()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
            Bài mới
          </button>
        </div>
        <div class="chart-container">
          <img src="${CHART_IMG}" alt="Pie Chart - Household Expenditures">
        </div>
      </div>
      <div style="flex:1;padding:8px 16px 16px;display:flex;flex-direction:column;gap:12px">
        <span class="form-label">Bài viết - ${escapeHtml(state.studentName)}</span>
        ${essaySection}
        ${resubmitBtn}
      </div>
    </div>
    <div class="panel" style="padding:24px">
      ${rightContent}
    </div>
  </div>`;
}

function render() {
  const app = document.getElementById('app');
  if (state.stage === 'idle') {
    app.innerHTML = renderIdleHome();
  } else {
    app.innerHTML = renderTwoStageLayout();
  }
}

render();
</script>
</body>
</html>